<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Reports Library - TeaTrade</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Styling (Bloomberg-inspired dark theme) */
        body {
            font-family: 'Roboto', sans-serif; background-color: #1a1e23; color: #f0f0f0; margin: 0; padding: 20px;
        }
        .container { max-width: 1400px; margin: auto; }
        h1, h2 { color: #ffffff; }
        h2 { border-bottom: 2px solid #333840; padding-bottom: 10px; margin-top: 20px;}
        
        /* --- List View Styles --- */
        #report-list-view { padding: 20px; }
        .search-bar { margin-bottom: 20px; }
        .search-bar input { padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #333; background-color: #282c34; color: #f0f0f0; }
        .report-item { 
            background-color: #282c34; padding: 15px; margin-bottom: 10px; 
            border-radius: 5px; cursor: pointer; transition: background-color 0.3s;
        }
        .report-item:hover { background-color: #333840; }
        .report-title { font-size: 1.2em; color: #61dafb; }
        .report-meta { font-size: 0.9em; color: #aaaaaa; }

        /* --- Detail View Styles --- */
        #report-detail-view { display: none; padding: 20px; }
        #back-button { margin-bottom: 20px; padding: 10px 15px; cursor: pointer; background-color: #61dafb; color: #1a1e23; border: none; border-radius: 5px; font-weight: bold;}

        /* KPI Cards */
        .kpi-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background-color: #282c34; padding: 20px; border-radius: 5px; border-left: 4px solid #61dafb; }
        .kpi-title { font-size: 1em; color: #aaaaaa; margin-bottom: 10px; }
        .kpi-value { font-size: 1.5em; font-weight: 700; color: #ffffff; }
        .positive { color: #4caf50; }
        .negative { color: #f44336; }
        .neutral { color: #aaaaaa; }

        /* Grid Layout for Charts/Tables */
        .grid-layout { display: grid; gap: 20px; margin-bottom: 30px; grid-template-columns: 1fr 1fr; }
        .panel { background-color: #282c34; padding: 20px; border-radius: 5px; }

        /* Table Styles */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #333840; }
        .data-table th { background-color: #333840; color: #61dafb; }

        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>TeaTrade Market Intelligence</h1>
        
        <div id="report-list-view">
            <h2>Available Reports (Mombasa)</h2>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search by Sale Number or Date...">
            </div>
            <div id="report-list-container">Loading...</div>
        </div>

        <div id="report-detail-view">
            <button id="back-button">‚Üê Back to List</button>
            <h2 id="detail-title">Report Details</h2>
            
            <div class="kpi-cards">
                <div class="kpi-card"><div class="kpi-title">Total Volume (kg)</div><div class="kpi-value" id="kpi-volume">...</div></div>
                <div class="kpi-card"><div class="kpi-title">Average Price (USD/kg)</div><div class="kpi-value" id="kpi-price">...</div></div>
                <div class="kpi-card" id="kpi-change-card"><div class="kpi-title">Change vs Prev. Sale</div><div class="kpi-value" id="kpi-change">...</div></div>
                <div class="kpi-card"><div class="kpi-title">Sell-Through Rate</div><div class="kpi-value" id="kpi-sellthrough">...</div></div>
                <div class="kpi-card"><div class="kpi-title">Price Realization</div><div class="kpi-value" id="kpi-realization">...</div></div>
            </div>

            <div class="grid-layout">
                <div class="panel">
                    <div id="chart-buyers"></div>
                </div>
                <div class="panel">
                    <div id="chart-grades"></div>
                </div>
            </div>

            <div class="panel">
                <h2>Top Gardens by Price Realization</h2>
                <table class="data-table" id="table-gardens">
                    <thead><tr><th>Garden</th><th>Volume (kg)</th><th>Avg Price</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const DATA_DIR = 'report_data/';
        const INDEX_FILE = 'mombasa_index.json';
        const listView = document.getElementById('report-list-view');
        const detailView = document.getElementById('report-detail-view');
        const listContainer = document.getElementById('report-list-container');
        let globalIndexData = [];

        // --- View Switching Logic ---
        function showList() {
            detailView.style.display = 'none';
            listView.style.display = 'block';
        }

        function showDetail(filename) {
            listView.style.display = 'none';
            detailView.style.display = 'block';
            loadReportDetail(filename);
        }

        document.getElementById('back-button').addEventListener('click', showList);

        // --- Data Loading and Rendering ---

        async function loadIndex() {
            try {
                // Add a cache-busting parameter to ensure the latest file is loaded
                const response = await fetch(DATA_DIR + INDEX_FILE + '?v=' + new Date().getTime());
                if (!response.ok) throw new Error('Network response was not ok.');
                globalIndexData = await response.json();
                renderIndex(globalIndexData);
            } catch (error) {
                console.error('Error loading index:', error);
                listContainer.innerHTML = '<p>Error loading reports. Please check the data directory.</p>';
            }
        }

        function renderIndex(data) {
            listContainer.innerHTML = '';
            if (data.length === 0) {
                listContainer.innerHTML = '<p>No reports found.</p>';
                return;
            }
            data.forEach(report => {
                const item = document.createElement('div');
                item.className = 'report-item';
                item.innerHTML = `
                    <div class="report-title">Sale ${report.sale_number} (${report.location})</div>
                    <div class="report-meta">Date: ${report.sale_date}</div>
                `;
                item.addEventListener('click', () => showDetail(report.filename));
                listContainer.appendChild(item);
            });
        }

        // Search/Filter Functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const filter = this.value.toUpperCase();
            const filteredData = globalIndexData.filter(report => 
                report.sale_number.toUpperCase().includes(filter) || 
                report.sale_date.toUpperCase().includes(filter)
            );
            renderIndex(filteredData);
        });


        async function loadReportDetail(filename) {
            // Reset KPIs while loading
            document.querySelectorAll('.kpi-value').forEach(el => el.textContent = 'Loading...');
            
            try {
                const response = await fetch(DATA_DIR + filename + '?v=' + new Date().getTime());
                if (!response.ok) throw new Error('Network response was not ok.');
                const reportData = await response.json();
                renderDetail(reportData);
            } catch (error) {
                console.error('Error loading report detail:', error);
                alert('Failed to load report details.');
                showList();
            }
        }

        function renderDetail(data) {
            document.getElementById('detail-title').textContent = `Mombasa Auction Report - Sale ${data.metadata.sale_number} (${data.metadata.sale_date})`;

            // Render KPIs
            if (data.kpis) {
                document.getElementById('kpi-volume').textContent = data.kpis.TOTAL_VOLUME;
                document.getElementById('kpi-price').textContent = data.kpis.AVG_PRICE;
                document.getElementById('kpi-sellthrough').textContent = data.kpis.SELL_THROUGH_RATE;
                document.getElementById('kpi-realization').textContent = data.kpis.REALIZATION_RATE;


                const changeEl = document.getElementById('kpi-change');
                changeEl.textContent = data.kpis.PRICE_CHANGE;
                changeEl.className = 'kpi-value ' + data.kpis.PRICE_CHANGE_CLASS;
                
                // Adjust border color
                const changeCard = document.getElementById('kpi-change-card');
                const colorMap = {'positive': '#4caf50', 'negative': '#f44336', 'neutral': '#aaaaaa'};
                changeCard.style.borderLeftColor = colorMap[data.kpis.PRICE_CHANGE_CLASS] || '#aaaaaa';
            }

            // Render Charts
            embedChart('chart-buyers', data.charts.buyers);
            embedChart('chart-grades', data.charts.grades);

            // Render Tables
            renderGardenTable(data.tables.gardens);
        }

        function renderGardenTable(data) {
            const tbody = document.getElementById('table-gardens').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">No significant garden data for this week.</td></tr>';
                return;
            }
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.mark}</td><td>${row.total_volume}</td><td>${row.avg_price}</td>`;
                tbody.appendChild(tr);
            });
        }

        function embedChart(id, spec) {
            if (!spec || Object.keys(spec).length === 0) {
                document.getElementById(id).innerHTML = "<p style='color: #aaaaaa; padding: 20px;'>Chart data unavailable.</p>";
                return;
            }
            // Customize theme for dark background compatibility
            const config = {
                background: null,
                title: { color: '#ffffff' },
                axis: { labelColor: '#aaaaaa', titleColor: '#ffffff', gridColor: '#333840', domainColor: '#333840' },
                legend: { labelColor: '#aaaaaa', titleColor: '#ffffff' },
                view: { stroke: null }
            };
            // Ensure responsiveness
            if (spec.data) {
                 spec.width = "container";
            }
           
            vegaEmbed(`#${id}`, spec, {mode: 'vega-lite', config: config, actions: false}).catch(console.error);
        }

        // Initialize the view
        loadIndex();
    </script>
</body>
</html>